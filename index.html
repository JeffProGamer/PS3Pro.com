<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PS3 Pro Site</title>
  <link rel="stylesheet" href="css/output.css">
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: #000;
      font-family: Arial, sans-serif;
      color: #fff;
    }
    #boot-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 20;
      animation: fadeOut 3s forwards 2s;
    }
    #boot-screen img {
      width: 200px;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 0.7; }
      50% { transform: scale(1.2); opacity: 1; }
    }
    @keyframes fadeOut {
      to { opacity: 0; display: none; }
    }
    #background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: -1;
      background: linear-gradient(135deg, #1a1a1a, #4a4a4a, #1a1a1a);
      animation: waveAnimation 10s infinite linear;
      filter: brightness(1.3);
    }
    #background.theme-blue {
      background: linear-gradient(135deg, #1a1a3a, #4a4a8a, #1a1a3a);
    }
    #background.theme-red {
      background: linear-gradient(135deg, #3a1a1a, #8a4a4a, #3a1a1a);
    }
    @keyframes waveAnimation {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }
    .xmb-item {
      transition: all 0.3s ease;
    }
    .xmb-item img {
      width: 64px;
      height: 64px;
      filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.7));
    }
    .xmb-item:hover {
      transform: scale(1.2);
      filter: brightness(1.3);
    }
    .xmb-item.active img {
      animation: frameAnimation 0.8s steps(4) infinite;
    }
    .submenu {
      display: none;
      background: rgba(0, 0, 0, 0.9);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
    }
    .submenu.active {
      animation: slideIn 0.4s ease;
    }
    .submenu-item {
      transition: all 0.3s ease;
    }
    .submenu-item:hover {
      transform: translateX(8px);
      background: rgba(255, 255, 255, 0.3);
    }
    #game-canvas, #login-screen {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: #000;
      z-index: 10;
    }
    #game-canvas.active, #login-screen.active {
      display: block;
    }
    #login-screen {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #login-form {
      background: rgba(0, 0, 0, 0.9);
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 0 25px rgba(255, 255, 255, 0.5);
      width: 400px;
      text-align: center;
    }
    #login-form input, #login-form select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #555;
      border-radius: 5px;
      background: #222;
      color: #fff;
      transition: all 0.3s ease;
    }
    #login-form input:focus, #login-form select:focus {
      border-color: #fff;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.7);
    }
    #login-form button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    #login-form button:hover {
      transform: scale(1.1);
      filter: brightness(1.2);
    }
    #login-form button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    #login-message {
      margin-top: 10px;
      color: #f00;
      animation: fadeIn 0.5s ease;
    }
    @keyframes slideIn {
      from { transform: translateX(-50%) translateY(-30px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes frameAnimation {
      0% { transform: translateX(0); }
      100% { transform: translateX(-256px); }
    }
    .no-animations .xmb-item, .no-animations .submenu, .no-animations .submenu-item,
    .no-animations #login-form input, .no-animations #login-form select,
    .no-animations #login-form button {
      transition: none !important;
      animation: none !important;
    }
    .no-animations #background {
      animation: none !important;
    }
    #xmb-container {
      animation: fadeIn 0.5s ease;
    }
  </style>
</head>
<body>
  <div id="boot-screen">
    <img src="https://via.placeholder.com/200?text=PS3+Pro+Site+Logo" alt="PS3 Pro Site Logo">
  </div>
  <div id="background"></div>
  <div class="flex justify-center items-center h-screen relative hidden" id="xmb-container">
    <h1 class="absolute top-4 left-4 text-2xl font-bold text-white/90">PS3 Pro Site</h1>
    <h2 id="user-welcome" class="absolute top-4 right-4 text-lg text-white/80"></h2>
    <div class="flex justify-around w-full absolute top-[20%] xmb-menu">
      <div class="text-center cursor-pointer transition-all duration-300 opacity-50 xmb-item active scale-125 opacity-100" data-menu="users">
        <img src="https://via.placeholder.com/64?text=Users" alt="Users">
        <p>Users</p>
      </div>
      <div class="text-center cursor-pointer transition-all duration-300 opacity-50 xmb-item" data-menu="settings">
        <img src="https://via.placeholder.com/64?text=Settings" alt="Settings">
        <p>Settings</p>
      </div>
      <div class="text-center cursor-pointer transition-all duration-300 opacity-50 xmb-item" data-menu="games">
        <img src="https://via.placeholder.com/64?text=Games" alt="Games">
        <p>Games</p>
      </div>
      <div class="text-center cursor-pointer transition-all duration-300 opacity-50 xmb-item" data-menu="media">
        <img src="https://via.placeholder.com/64?text=Media" alt="Media">
        <p>Media</p>
      </div>
      <div class="text-center cursor-pointer transition-all duration-300 opacity-50 xmb-item" data-menu="network">
        <img src="https://via.placeholder.com/64?text=Network" alt="Network">
        <p>Network</p>
      </div>
    </div>
    <div class="absolute top-[30%] left-1/2 -translate-x-1/2 submenu active block" id="users-submenu">
      <div class="p-2.5 m-1.25 cursor-pointer hover:bg-white/20 transition-colors duration-300 submenu-item" data-action="signout">Sign Out</div>
      <div class="p-2.5 m-1.25 cursor-pointer hover:bg-white/20 transition-colors duration-300 submenu-item" id="user-profile"></div>
    </div>
    <div class="absolute top-[30%] left-1/2 -translate-x-1/2 submenu" id="settings-submenu">
      <div class="p-2.5 m-1.25 cursor-pointer hover:bg-white/20 transition-colors duration-300 submenu-item" data-theme="default">Theme: Default</div>
      <div class="p-2.5 m-1.25 cursor-pointer hover:bg-white/20 transition-colors duration-300 submenu-item" data-theme="blue">Theme: Blue</div>
      <div class="p-2.5 m-1.25 cursor-pointer hover:bg-white/20 transition-colors duration-300 submenu-item" data-theme="red">Theme: Red</div>
      <div class="p-2.5 m-1.25 cursor-pointer hover:bg-white/20 transition-colors duration-300 submenu-item" data-setting="animations">Animations: On</div>
      <div class="p-2.5 m-1.25 cursor-pointer hover:bg-white/20 transition-colors duration-300 submenu-item" data-setting="fastMode">Fast Mode: Off</div>
    </div>
    <div class="absolute top-[30%] left-1/2 -translate-x-1/2 submenu" id="games-submenu">
      <div class="p-2.5 m-1.25 cursor-pointer hover:bg-white/20 transition-colors duration-300 submenu-item" data-game="snake">Play Snake</div>
      <div class="p-2.5 m-1.25 cursor-pointer hover:bg-white/20 transition-colors duration-300 submenu-item" data-game="platformer">Play Platformer</div>
    </div>
    <div class="absolute top-[30%] left-1/2 -translate-x-1/2 submenu" id="media-submenu">
      <div class="p-2.5 m-1.25 cursor-pointer hover:bg-white/20 transition-colors duration-300 submenu-item">Music</div>
      <div class="p-2.5 m-1.25 cursor-pointer hover:bg-white/20 transition-colors duration-300 submenu-item">Videos</div>
      <div class="p-2.5 m-1.25 cursor-pointer hover:bg-white/20 transition-colors duration-300 submenu-item">Photos</div>
    </div>
    <div class="absolute top-[30%] left-1/2 -translate-x-1/2 submenu" id="network-submenu">
      <div class="p-2.5 m-1.25 cursor-pointer hover:bg-white/20 transition-colors duration-300 submenu-item">Internet Browser</div>
      <div class="p-2.5 m-1.25 cursor-pointer hover:bg-white/20 transition-colors duration-300 submenu-item">PlayStation Store</div>
    </div>
    <canvas id="game-canvas" width="800" height="600"></canvas>
  </div>
  <div id="login-screen" class="active">
    <div id="login-form">
      <h2 class="text-xl font-bold mb-4">Sign In to PS3 Pro Site</h2>
      <input type="text" id="username" placeholder="Email or PSN ID" class="mb-4">
      <input type="password" id="password" placeholder="Password" class="mb-4">
      <select id="provider" class="mb-4">
        <option value="hotmail">Hotmail/Outlook</option>
        <option value="gmail">Gmail</option>
        <option value="psn">PSN</option>
      </select>
      <div class="flex justify-center gap-2">
        <button id="signin-btn" class="bg-blue-600 hover:bg-blue-700 text-white" onclick="signIn()">Sign In</button>
        <button class="bg-gray-600 hover:bg-gray-700 text-white" onclick="cancelSignIn()">Cancel</button>
      </div>
      <p id="login-message"></p>
    </div>
  </div>
  <script>
    // User Management
    let user = null;
    const backendUrl = 'http://localhost:3000';
    const xmbContainer = document.getElementById('xmb-container');
    const loginScreen = document.getElementById('login-screen');
    const userWelcome = document.getElementById('user-welcome');
    const userProfile = document.getElementById('user-profile');
    const background = document.getElementById('background');
    const signinBtn = document.getElementById('signin-btn');

    const validateCredentials = (username, provider) => {
      if (provider === 'psn') {
        return /^[a-zA-Z0-9_-]{3,16}$/.test(username);
      } else {
        return provider === 'hotmail' ? /^[\w-\.]+@(hotmail|outlook)\.com$/.test(username) :
               provider === 'gmail' ? /^[\w-\.]+@gmail\.com$/.test(username) : false;
      }
    };

    const updateUserUI = () => {
      if (user) {
        userWelcome.textContent = `Welcome, ${user.username}`;
        userProfile.textContent = `${user.username}'s Profile`;
        background.className = `theme-${user.theme || 'default'}`;
        document.body.classList.toggle('no-animations', !user.animations);
        document.querySelector('[data-setting="animations"]').textContent = `Animations: ${user.animations ? 'On' : 'Off'}`;
        document.querySelector('[data-setting="fastMode"]').textContent = `Fast Mode: ${user.fastMode ? 'On' : 'Off'}`;
      } else {
        userWelcome.textContent = '';
        userProfile.textContent = 'Guest';
        background.className = 'theme-default';
        document.body.classList.remove('no-animations');
      }
    };

    const saveUserData = async () => {
      try {
        localStorage.setItem('ps3ProUserSettings', JSON.stringify({
          theme: user.theme,
          animations: user.animations,
          fastMode: user.fastMode,
          snakeHighScore: user.snakeHighScore || 0,
          platformerHighScore: user.platformerHighScore || 0
        }));
        const token = localStorage.getItem('ps3ProToken');
        if (token) {
          await fetch(`${backendUrl}/save`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({
              theme: user.theme,
              animations: user.animations,
              fastMode: user.fastMode,
              snakeHighScore: user.snakeHighScore || 0,
              platformerHighScore: user.platformerHighScore || 0
            })
          });
        }
      } catch (e) {
        console.warn('Failed to save user data:', e);
      }
    };

    window.signIn = async () => {
      signinBtn.disabled = true;
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const provider = document.getElementById('provider').value;
      const message = document.getElementById('login-message');

      if (!username || !password) {
        message.textContent = 'Please enter username and password';
        message.style.color = '#f00';
        signinBtn.disabled = false;
        return;
      }

      if (!validateCredentials(username, provider)) {
        message.textContent = 'Invalid email or PSN ID';
        message.style.color = '#f00';
        signinBtn.disabled = false;
        return;
      }

      try {
        const ping = await fetch(`${backendUrl}/ping`);
        if (!ping.ok) {
          message.textContent = 'Server unreachable';
          message.style.color = '#f00';
          signinBtn.disabled = false;
          return;
        }
        const response = await fetch(`${backendUrl}/signin`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, provider })
        });
        const data = await response.json();
        if (data.token) {
          try {
            localStorage.setItem('ps3ProToken', data.token);
          } catch (e) {
            console.warn('Failed to save token to localStorage:', e);
          }
          user = {
            username,
            provider,
            theme: 'default',
            animations: true,
            fastMode: false,
            snakeHighScore: 0,
            platformerHighScore: 0
          };
          const loadResponse = await fetch(`${backendUrl}/load`, {
            headers: { 'Authorization': `Bearer ${data.token}` }
          });
          if (loadResponse.ok) {
            const savedData = await loadResponse.json();
            user.theme = savedData.theme || 'default';
            user.animations = savedData.animations ?? true;
            user.fastMode = savedData.fastMode ?? false;
            user.snakeHighScore = savedData.snakeHighScore || 0;
            user.platformerHighScore = savedData.platformerHighScore || 0;
          }
          saveUserData();
          message.textContent = `Signed in as ${username}`;
          message.style.color = '#0f0';
          setTimeout(() => {
            loginScreen.remove();
            xmbContainer.classList.remove('hidden');
            updateUserUI();
            signinBtn.disabled = false;
          }, 1000);
        } else {
          message.textContent = data.error || 'Sign-in failed';
          message.style.color = '#f00';
          signinBtn.disabled = false;
        }
      } catch (e) {
        message.textContent = 'Error connecting to server';
        message.style.color = '#f00';
        console.warn('Sign-in error:', e);
        signinBtn.disabled = false;
      }
    };

    window.cancelSignIn = () => {
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      document.getElementById('login-message').textContent = '';
      signinBtn.disabled = false;
    };

    const verifySession = async () => {
      try {
        const token = localStorage.getItem('ps3ProToken');
        if (!token) return false;
        const response = await fetch(`${backendUrl}/verify`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
          const userResponse = await fetch(`${backendUrl}/user`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (userResponse.ok) {
            const userData = await userResponse.json();
            const loadResponse = await fetch(`${backendUrl}/load`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            const savedData = loadResponse.ok ? await loadResponse.json() : {};
            user = {
              username: userData.username,
              provider: userData.provider,
              theme: savedData.theme || 'default',
              animations: savedData.animations ?? true,
              fastMode: savedData.fastMode ?? false,
              snakeHighScore: savedData.snakeHighScore || 0,
              platformerHighScore: savedData.platformerHighScore || 0
            };
            loginScreen.remove();
            xmbContainer.classList.remove('hidden');
            updateUserUI();
            return true;
          }
        }
        localStorage.removeItem('ps3ProToken');
      } catch (e) {
        console.warn('Session verification failed:', e);
      }
      return false;
    };

    document.querySelector('.submenu-item[data-action="signout"]').addEventListener('click', () => {
      try {
        localStorage.removeItem('ps3ProToken');
        localStorage.removeItem('ps3ProUserSettings');
      } catch (e) {
        console.warn('Failed to clear localStorage:', e);
      }
      user = null;
      window.location.reload();
    });

    document.querySelectorAll('.submenu-item[data-theme]').forEach(item => {
      item.addEventListener('click', () => {
        if (user) {
          user.theme = item.dataset.theme;
          saveUserData();
          updateUserUI();
        }
      });
    });

    document.querySelector('[data-setting="animations"]').addEventListener('click', () => {
      if (user) {
        user.animations = !user.animations;
        saveUserData();
        updateUserUI();
      }
    });

    document.querySelector('[data-setting="fastMode"]').addEventListener('click', () => {
      if (user) {
        user.fastMode = !user.fastMode;
        saveUserData();
        updateUserUI();
      }
    });

    // Performance and GPU Detection
    let performanceLevel = 'high';
    let useWebGL = false;
    const testPerformance = () => {
      const start = performance.now();
      let sum = 0;
      for (let i = 0; i < 1000000; i++) sum += Math.sqrt(i);
      const time = performance.now() - start;
      performanceLevel = time > 50 ? 'low' : time > 30 ? 'medium' : 'high';
      const canvas = document.createElement('canvas');
      useWebGL = !!(canvas.getContext('webgl') || canvas.getContext('experimental-webgl'));
      if (!useWebGL) console.warn('WebGL not supported, falling back to Canvas 2D');
    };
    testPerformance();

    // WebGL Setup
    let gl = null;
    let ctx = document.getElementById('game-canvas').getContext('2d');
    let program, positionLocation, normalLocation, modelMatrixLocation, viewMatrixLocation, projMatrixLocation, colorLocation, timeLocation;

    const initWebGL = () => {
      gl = document.getElementById('game-canvas').getContext('webgl') || document.getElementById('game-canvas').getContext('experimental-webgl');
      if (!gl) {
        console.warn('WebGL initialization failed, using Canvas 2D');
        useWebGL = false;
        return false;
      }

      const vertexShaderSource = `
        attribute vec3 a_position;
        attribute vec3 a_normal;
        uniform mat4 u_modelMatrix;
        uniform mat4 u_viewMatrix;
        uniform mat4 u_projMatrix;
        uniform float u_time;
        varying vec3 v_normal;
        void main() {
          float pulse = 0.95 + 0.05 * sin(u_time * 0.01);
          gl_Position = u_projMatrix * u_viewMatrix * u_modelMatrix * vec4(a_position * pulse, 1.0);
          v_normal = normalize((u_modelMatrix * vec4(a_normal, 0.0)).xyz);
        }
      `;
      const fragmentShaderSource = `
        precision mediump float;
        uniform vec4 u_color;
        uniform float u_time;
        varying vec3 v_normal;
        void main() {
          vec3 lightDir = normalize(vec3(1.0, 1.0, 1.0));
          float diff = max(dot(v_normal, lightDir), 0.2);
          float glow = 0.8 + 0.2 * sin(u_time * 0.01);
          gl_FragColor = vec4(u_color.rgb * diff * glow, u_color.a);
        }
      `;

      const createShader = (type, source) => {
        const shader = gl.createShader(type);
        gl.shaderSource(shader, source);
        gl.compileShader(shader);
        if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
          console.error('Shader compile error:', gl.getShaderInfoLog(shader));
          gl.deleteShader(shader);
          return null;
        }
        return shader;
      };

      const vertexShader = createShader(gl.VERTEX_SHADER, vertexShaderSource);
      const fragmentShader = createShader(gl.FRAGMENT_SHADER, fragmentShaderSource);
      if (!vertexShader || !fragmentShader) {
        gl = null;
        useWebGL = false;
        return false;
      }

      program = gl.createProgram();
      gl.attachShader(program, vertexShader);
      gl.attachShader(program, fragmentShader);
      gl.linkProgram(program);
      if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
        console.error('Program link error:', gl.getProgramInfoLog(program));
        gl.deleteProgram(program);
        gl = null;
        useWebGL = false;
        return false;
      }

      gl.useProgram(program);
      positionLocation = gl.getAttribLocation(program, 'a_position');
      normalLocation = gl.getAttribLocation(program, 'a_normal');
      modelMatrixLocation = gl.getUniformLocation(program, 'u_modelMatrix');
      viewMatrixLocation = gl.getUniformLocation(program, 'u_viewMatrix');
      projMatrixLocation = gl.getUniformLocation(program, 'u_projMatrix');
      colorLocation = gl.getUniformLocation(program, 'u_color');
      timeLocation = gl.getUniformLocation(program, 'u_time');

      gl.enable(gl.DEPTH_TEST);
      gl.viewport(0, 0, 800, 600);
      const projMatrix = [
        2 / 800, 0, 0, 0,
        0, -2 / 600, 0, 0,
        0, 0, -2 / 1000, 0,
        -1, 1, -1, 1
      ];
      const viewMatrix = [
        1, 0, 0, 0,
        0, 1, 0, 0,
        0, 0, 1, 0,
        0, 0, -400, 1
      ];
      gl.uniformMatrix4fv(projMatrixLocation, false, projMatrix);
      gl.uniformMatrix4fv(viewMatrixLocation, false, viewMatrix);
      return true;
    };

    function drawCube(x, y, z, size, color, time) {
      if (!useWebGL || !gl) return;
      const modelMatrix = [
        1, 0, 0, 0,
        0, 1, 0, 0,
        0, 0, 1, 0,
        x, y, z, 1
      ];
      gl.uniformMatrix4fv(modelMatrixLocation, false, modelMatrix);
      gl.uniform4f(colorLocation, color[0], color[1], color[2], 1);
      gl.uniform1f(timeLocation, time);

      const vertices = new Float32Array([
        // Front
        -size, -size, size, size, -size, size, size, size, size,
        -size, -size, size, size, size, size, -size, size, size,
        // Back
        -size, -size, -size, size, size, -size, size, -size, -size,
        -size, -size, -size, -size, size, -size, size, size, -size,
        // Top
        -size, size, -size, size, size, size, size, size, -size,
        -size, size, -size, -size, size, size, size, size, size,
        // Bottom
        -size, -size, -size, size, -size, -size, size, -size, size,
        -size, -size, -size, size, -size, size, -size, -size, size,
        // Right
        size, -size, -size, size, size, size, size, -size, size,
        size, -size, -size, size, size, -size, size, size, size,
        // Left
        -size, -size, -size, -size, -size, size, -size, size, size,
        -size, -size, -size, -size, size, -size, -size, size, size
      ]);
      const normals = new Float32Array([
        // Front
        0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1,
        // Back
        0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1,
        // Top
        0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0,
        // Bottom
        0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0,
        // Right
        1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0,
        // Left
        -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0, 0
      ]);

      const vertexBuffer = gl.createBuffer();
      gl.bindBuffer(gl.ARRAY_BUFFER, vertexBuffer);
      gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW);
      gl.enableVertexAttribArray(positionLocation);
      gl.vertexAttribPointer(positionLocation, 3, gl.FLOAT, false, 0, 0);

      const normalBuffer = gl.createBuffer();
      gl.bindBuffer(gl.ARRAY_BUFFER, normalBuffer);
      gl.bufferData(gl.ARRAY_BUFFER, normals, gl.STATIC_DRAW);
      gl.enableVertexAttribArray(normalLocation);
      gl.vertexAttribPointer(normalLocation, 3, gl.FLOAT, false, 0, 0);

      gl.drawArrays(gl.TRIANGLES, 0, 36);
    }

    // Game Logic
    const gameSettings = {
      snake: {
        speed: user && user.fastMode ? 20 : (performanceLevel === 'high' ? 15 : performanceLevel === 'medium' ? 10 : 6),
        particles: user && user.fastMode ? 5 : (performanceLevel === 'high' ? 30 : 15)
      },
      platformer: {
        jumpHeight: user && user.fastMode ? 20 : (performanceLevel === 'high' ? 15 : 10),
        speed: user && user.fastMode ? 7 : (performanceLevel === 'high' ? 5 : 3),
        fps: user && user.fastMode ? 120 : 60
      }
    };

    class SnakeGame {
      constructor(multiplayer = false) {
        this.gridSize = 20;
        this.tileCount = 800 / this.gridSize;
        this.snake = [{ x: 10, y: 10, z: 0 }];
        this.food = { x: 15, y: 15, z: 0 };
        this.dx = 0;
        this.dy = 0;
        this.score = user?.snakeHighScore || 0;
        this.particles = [];
        this.running = false;
        this.multiplayer = multiplayer;
        this.otherSnakes = multiplayer ? (JSON.parse(localStorage.getItem('snakeMultiplayer')) || []) : [];
        this.lastUpdate = 0;
      }
      start() {
        this.running = true;
        document.getElementById('game-canvas').classList.add('active');
        xmbContainer.classList.add('hidden');
        if (useWebGL) initWebGL();
        document.removeEventListener('keydown', this.handleInput);
        document.addEventListener('keydown', this.handleInput.bind(this));
        this.gameLoop(performance.now());
      }
      stop() {
        this.running = false;
        document.getElementById('game-canvas').classList.remove('active');
        xmbContainer.classList.remove('hidden');
        document.removeEventListener('keydown', this.handleInput);
        if (this.multiplayer && user) {
          try {
            localStorage.setItem('snakeMultiplayer', JSON.stringify(this.otherSnakes.slice(0, 5)));
          } catch (e) {
            console.warn('Failed to save multiplayer state:', e);
          }
        }
        if (user && this.score > user.snakeHighScore) {
          user.snakeHighScore = this.score;
          saveUserData();
        }
      }
      handleInput(e) {
        if (e.key === 'ArrowUp' && this.dy === 0) { this.dx = 0; this.dy = -1; }
        else if (e.key === 'ArrowDown' && this.dy === 0) { this.dx = 0; this.dy = 1; }
        else if (e.key === 'ArrowLeft' && this.dx === 0) { this.dx = -1; this.dy = 0; }
        else if (e.key === 'ArrowRight' && this.dx === 0) { this.dx = 1; this.dy = 0; }
        else if (e.key === 'Escape') this.stop();
      }
      update(time) {
        if (!this.running) return;
        const delta = time - this.lastUpdate;
        if (delta < 1000 / gameSettings.snake.speed) return;
        this.lastUpdate = time;
        const head = { x: this.snake[0].x + this.dx, y: this.snake[0].y + this.dy, z: 0 };
        if (head.x < 0 || head.x >= this.tileCount || head.y < 0 || head.y >= this.tileCount || this.snake.some(s => s.x === head.x && s.y === head.y)) {
          this.stop();
          return;
        }
        this.snake.unshift(head);
        if (head.x === this.food.x && head.y === this.food.y) {
          this.score += 10;
          this.food = { x: Math.floor(Math.random() * this.tileCount), y: Math.floor(Math.random() * this.tileCount), z: 0 };
          for (let i = 0; i < gameSettings.snake.particles; i++) {
            this.particles.push({ x: head.x * this.gridSize, y: head.y * this.gridSize, z: 0, vx: (Math.random() - 0.5) * 3, vy: (Math.random() - 0.5) * 3, vz: (Math.random() - 0.5) * 3, life: 50 });
          }
        } else {
          this.snake.pop();
        }
        this.particles = this.particles.map(p => ({ ...p, x: p.x + p.vx, y: p.y + p.vy, z: p.z + p.vz, life: p.life - 1 })).filter(p => p.life > 0);
        if (this.multiplayer) {
          this.otherSnakes = this.otherSnakes.map(s => ({
            ...s,
            x: Math.max(0, Math.min(this.tileCount - 1, s.x + (Math.random() > 0.5 ? 1 : -1) * (Math.random() > 0.5 ? 1 : 0))),
            y: Math.max(0, Math.min(this.tileCount - 1, s.y + (Math.random() > 0.5 ? 1 : -1) * (Math.random() > 0.5 ? 1 : 0))),
            z: 0
          }));
        }
      }
      draw(time) {
        if (useWebGL && gl) {
          gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
          this.snake.forEach(s => drawCube(s.x * this.gridSize, s.y * this.gridSize, s.z, this.gridSize / 2, [0, 1, 0], time));
          drawCube(this.food.x * this.gridSize, this.food.y * this.gridSize, this.food.z, this.gridSize / 2, [1, 0, 0], time);
          if (this.multiplayer) {
            this.otherSnakes.forEach(s => drawCube(s.x * this.gridSize, s.y * this.gridSize, s.z, this.gridSize / 2, [0, 0, 1], time));
          }
          this.particles.forEach(p => drawCube(p.x, p.y, p.z, 4, [1, 1, 1], time));
        } else {
          ctx.fillStyle = '#000';
          ctx.fillRect(0, 0, 800, 600);
          ctx.fillStyle = '#0f0';
          this.snake.forEach(s => ctx.fillRect(s.x * this.gridSize, s.y * this.gridSize, this.gridSize - 2, this.gridSize - 2));
          ctx.fillStyle = '#f00';
          ctx.beginPath();
          ctx.arc((this.food.x + 0.5) * this.gridSize, (this.food.y + 0.5) * this.gridSize, (this.gridSize - 2) / 2 * (1 + 0.2 * Math.sin(time * 0.005)), 0, Math.PI * 2);
          ctx.fill();
          if (this.multiplayer) {
            ctx.fillStyle = '#00f';
            this.otherSnakes.forEach(s => ctx.fillRect(s.x * this.gridSize, s.y * this.gridSize, this.gridSize - 2, this.gridSize - 2));
          }
          ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
          this.particles.forEach(p => ctx.fillRect(p.x, p.y, 4, 4));
          ctx.fillStyle = '#fff';
          ctx.font = '20px Arial';
          ctx.fillText(`Score: ${this.score}`, 10, 20);
          ctx.fillText(`High Score: ${user?.snakeHighScore || 0}`, 10, 50);
        }
      }
      gameLoop(time) {
        if (!this.running) return;
        this.update(time);
        this.draw(time);
        requestAnimationFrame(this.gameLoop.bind(this));
      }
    }

    class PlatformerGame {
      constructor(multiplayer = false) {
        this.player = { x: 50, y: 500, z: 0, vx: 0, vy: 0, vz: 0, width: 20, height: 40, depth: 20 };
        this.platforms = [
          { x: 0, y: 550, z: 0, width: 800, height: 50, depth: 200 },
          { x: 200, y: 400, z: 0, width: 100, height: 20, depth: 100 },
          { x: 400, y: 300, z: 0, width: 100, height: 20, depth: 100 }
        ];
        this.score = user?.platformerHighScore || 0;
        this.running = false;
        this.multiplayer = multiplayer;
        this.otherPlayer = multiplayer ? (JSON.parse(localStorage.getItem('platformerMultiplayer')) || { x: 100, y: 500, z: 0, vx: 0, vy: 0, vz: 0, width: 20, height: 40, depth: 20 }) : null;
        this.lastUpdate = 0;
      }
      start() {
        this.running = true;
        document.getElementById('game-canvas').classList.add('active');
        xmbContainer.classList.add('hidden');
        if (useWebGL) initWebGL();
        document.removeEventListener('keydown', this.handleInput);
        document.removeEventListener('keyup', this.handleKeyUp);
        document.addEventListener('keydown', this.handleInput.bind(this));
        document.addEventListener('keyup', this.handleKeyUp.bind(this));
        this.gameLoop(performance.now());
      }
      stop() {
        this.running = false;
        document.getElementById('game-canvas').classList.remove('active');
        xmbContainer.classList.remove('hidden');
        document.removeEventListener('keydown', this.handleInput);
        document.removeEventListener('keyup', this.handleKeyUp);
        if (this.multiplayer && user && this.otherPlayer) {
          try {
            localStorage.setItem('platformerMultiplayer', JSON.stringify(this.otherPlayer));
          } catch (e) {
            console.warn('Failed to save multiplayer state:', e);
          }
        }
        if (user && this.score > user.platformerHighScore) {
          user.platformerHighScore = this.score;
          saveUserData();
        }
      }
      handleInput(e) {
        if (e.key === 'ArrowLeft') this.player.vx = -gameSettings.platformer.speed;
        else if (e.key === 'ArrowRight') this.player.vx = gameSettings.platformer.speed;
        else if (e.key === 'ArrowUp' && this.isOnGround()) this.player.vy = -gameSettings.platformer.jumpHeight;
        else if (e.key === 'Escape') this.stop();
      }
      handleKeyUp(e) {
        if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') this.player.vx = 0;
      }
      isOnGround(player = this.player) {
        return this.platforms.some(p =>
          player.y + player.height >= p.y &&
          player.y + player.height <= p.y + p.height &&
          player.x + player.width > p.x &&
          player.x < p.x + p.width &&
          player.z + player.depth > p.z &&
          player.z < p.z + p.depth
        );
      }
      update(time) {
        if (!this.running) return;
        const delta = time - this.lastUpdate;
        if (delta < 1000 / Math.min(gameSettings.platformer.fps, 120)) return;
        this.lastUpdate = time;
        this.player.x = Math.max(0, Math.min(800 - this.player.width, this.player.x + this.player.vx));
        this.player.y += this.player.vy;
        if (!this.isOnGround()) this.player.vy += 0.5;
        else { this.player.vy = 0; this.score += 1; }
        if (this.player.y + this.player.height > 600) {
          this.player.y = 600 - this.player.height;
          this.player.vy = 0;
        }
        this.platforms.forEach(p => {
          if (this.player.vy > 0 && this.player.y + this.player.height <= p.y && this.player.y + this.player.height + this.player.vy > p.y &&
              this.player.x + this.player.width > p.x && this.player.x < p.x + p.width &&
              this.player.z + this.player.depth > p.z && this.player.z < p.z + p.depth) {
            this.player.y = p.y - this.player.height;
            this.player.vy = 0;
          }
        });
        if (this.multiplayer && this.otherPlayer) {
          this.otherPlayer.x = Math.max(0, Math.min(800 - this.otherPlayer.width, this.otherPlayer.x + this.otherPlayer.vx));
          this.otherPlayer.y += this.otherPlayer.vy;
          if (!this.isOnGround(this.otherPlayer)) this.otherPlayer.vy += 0.5;
          else this.otherPlayer.vy = 0;
          if (this.otherPlayer.y + this.otherPlayer.height > 600) {
            this.otherPlayer.y = 600 - this.otherPlayer.height;
            this.otherPlayer.vy = 0;
          }
          this.platforms.forEach(p => {
            if (this.otherPlayer.vy > 0 && this.otherPlayer.y + this.otherPlayer.height <= p.y &&
                this.otherPlayer.y + this.otherPlayer.height + this.otherPlayer.vy > p.y &&
                this.otherPlayer.x + this.otherPlayer.width > p.x && this.otherPlayer.x < p.x + p.width &&
                this.otherPlayer.z + this.otherPlayer.depth > p.z && this.otherPlayer.z < p.z + p.depth) {
              this.otherPlayer.y = p.y - this.otherPlayer.height;
              this.otherPlayer.vy = 0;
            }
          });
          this.otherPlayer.vx = (Math.random() - 0.5) * gameSettings.platformer.speed;
          if (Math.random() > 0.95 && this.isOnGround(this.otherPlayer)) this.otherPlayer.vy = -gameSettings.platformer.jumpHeight;
        }
      }
      draw(time) {
        if (useWebGL && gl) {
          gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
          drawCube(this.player.x, this.player.y, this.player.z, this.player.width / 2, [0, 0, 1], time);
          if (this.multiplayer && this.otherPlayer) {
            drawCube(this.otherPlayer.x, this.otherPlayer.y, this.otherPlayer.z, this.otherPlayer.width / 2, [1, 0, 0], time);
          }
          this.platforms.forEach(p => drawCube(p.x, p.y, p.z, p.width / 2, [0.333, 0.333, 0.333], time));
        } else {
          ctx.fillStyle = '#000';
          ctx.fillRect(0, 0, 800, 600);
          ctx.fillStyle = '#00f';
          ctx.beginPath();
          ctx.arc(this.player.x + this.player.width / 2, this.player.y + this.player.height / 2, this.player.width / 2 * (1 + 0.2 * Math.sin(time * 0.005)), 0, Math.PI * 2);
          ctx.fill();
          if (this.multiplayer && this.otherPlayer) {
            ctx.fillStyle = '#f00';
            ctx.beginPath();
            ctx.arc(this.otherPlayer.x + this.otherPlayer.width / 2, this.otherPlayer.y + this.otherPlayer.height / 2, this.otherPlayer.width / 2 * (1 + 0.2 * Math.sin(time * 0.005)), 0, Math.PI * 2);
            ctx.fill();
          }
          ctx.fillStyle = '#555';
          this.platforms.forEach(p => ctx.fillRect(p.x, p.y, p.width, p.height));
          ctx.fillStyle = '#fff';
          ctx.font = '20px Arial';
          ctx.fillText(`Score: ${this.score}`, 10, 20);
          ctx.fillText(`High Score: ${user?.platformerHighScore || 0}`, 10, 50);
        }
      }
      gameLoop(time) {
        if (!this.running) return;
        this.update(time);
        this.draw(time);
        requestAnimationFrame(this.gameLoop.bind(this));
      }
    }

    document.querySelectorAll('.submenu-item[data-game]').forEach(item => {
      item.addEventListener('click', () => {
        if (currentGame) currentGame.stop();
        if (item.dataset.game === 'snake') {
          currentGame = new SnakeGame(user != null);
          currentGame.start();
        } else if (item.dataset.game === 'platformer') {
          currentGame = new PlatformerGame(user != null);
          currentGame.start();
        }
      });
    });

    // Initialize
    verifySession();
  </script>
</body>
</html>